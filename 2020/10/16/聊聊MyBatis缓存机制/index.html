

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Alterem">
  <meta name="keywords" content="Alterem">
  <title>èŠèŠMyBatisç¼“å­˜æœºåˆ¶ - Alterem</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"alterem.github.io","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Alterem</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://github.com/alterem/picFB/raw/master/pics/2020/10/16/vFTKyq.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="èŠèŠMyBatisç¼“å­˜æœºåˆ¶">
              
            </span>
            <p id="hitokoto"> ... </p>
            <script>
              fetch('https://v1.hitokoto.cn')
                .then(response => response.json())
                .then(data => {
                  const hitokoto = document.getElementById('hitokoto')
                  hitokoto.innerText = 'ğŸš€â¤ï¸ ' + data.hitokoto + ' â€”ã€Š' + data.from + 'ã€‹ â¤ï¸ğŸš€'
                }).catch(console.error)
            </script>
            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-10-16 21:04" pubdate>
        2020å¹´10æœˆ16æ—¥ æ™šä¸Š
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.7k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      71
       åˆ†é’Ÿ
    </span>
  

  
  
    
      <!-- ä¸è’œå­ç»Ÿè®¡æ–‡ç« PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> æ¬¡
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">èŠèŠMyBatisç¼“å­˜æœºåˆ¶</h1>
            
            <div class="markdown-body">
              <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>MyBatisæ˜¯å¸¸è§çš„Javaæ•°æ®åº“è®¿é—®å±‚æ¡†æ¶ã€‚åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œå¼€å‘äººå‘˜å¤šæ•°æƒ…å†µä¸‹æ˜¯ä½¿ç”¨MyBatisçš„é»˜è®¤ç¼“å­˜é…ç½®ï¼Œä½†æ˜¯MyBatisç¼“å­˜æœºåˆ¶æœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„ï¼Œåœ¨ä½¿ç”¨ä¸­å®¹æ˜“å¼•èµ·è„æ•°æ®ï¼Œå½¢æˆä¸€äº›æ½œåœ¨çš„éšæ‚£ã€‚ä¸ªäººåœ¨ä¸šåŠ¡å¼€å‘ä¸­ä¹Ÿå¤„ç†è¿‡ä¸€äº›ç”±äºMyBatisç¼“å­˜å¼•å‘çš„å¼€å‘é—®é¢˜ï¼Œå¸¦ç€ä¸ªäººçš„å…´è¶£ï¼Œå¸Œæœ›ä»åº”ç”¨åŠæºç çš„è§’åº¦ä¸ºè¯»è€…æ¢³ç†MyBatisç¼“å­˜æœºåˆ¶ã€‚</p>
<p>æœ¬æ¬¡åˆ†æä¸­æ¶‰åŠåˆ°çš„ä»£ç å’Œæ•°æ®åº“è¡¨å‡æ”¾åœ¨GitHubä¸Šï¼Œåœ°å€ï¼š <a href="https://github.com/kailuncen/mybatis-cache-demo" target="_blank" rel="noopener">mybatis-cache-demo</a> ã€‚</p>
<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><p>æœ¬æ–‡æŒ‰ç…§ä»¥ä¸‹é¡ºåºå±•å¼€ã€‚</p>
<ul>
<li>ä¸€çº§ç¼“å­˜ä»‹ç»åŠç›¸å…³é…ç½®ã€‚</li>
<li>ä¸€çº§ç¼“å­˜å·¥ä½œæµç¨‹åŠæºç åˆ†æã€‚</li>
<li>ä¸€çº§ç¼“å­˜æ€»ç»“ã€‚</li>
<li>äºŒçº§ç¼“å­˜ä»‹ç»åŠç›¸å…³é…ç½®ã€‚</li>
<li>äºŒçº§ç¼“å­˜æºç åˆ†æã€‚</li>
<li>äºŒçº§ç¼“å­˜æ€»ç»“ã€‚</li>
<li>å…¨æ–‡æ€»ç»“ã€‚</li>
</ul>
<h2 id="ä¸€çº§ç¼“å­˜"><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h2><h3 id="ä¸€çº§ç¼“å­˜ä»‹ç»"><a href="#ä¸€çº§ç¼“å­˜ä»‹ç»" class="headerlink" title="ä¸€çº§ç¼“å­˜ä»‹ç»"></a>ä¸€çº§ç¼“å­˜ä»‹ç»</h3><p>åœ¨åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½åœ¨ä¸€æ¬¡æ•°æ®åº“ä¼šè¯ä¸­ï¼Œæ‰§è¡Œå¤šæ¬¡æŸ¥è¯¢æ¡ä»¶å®Œå…¨ç›¸åŒçš„SQLï¼ŒMyBatisæä¾›äº†ä¸€çº§ç¼“å­˜çš„æ–¹æ¡ˆä¼˜åŒ–è¿™éƒ¨åˆ†åœºæ™¯ï¼Œå¦‚æœæ˜¯ç›¸åŒçš„SQLè¯­å¥ï¼Œä¼šä¼˜å…ˆå‘½ä¸­ä¸€çº§ç¼“å­˜ï¼Œé¿å…ç›´æ¥å¯¹æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢ï¼Œæé«˜æ€§èƒ½ã€‚å…·ä½“æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/6e38df6a.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>æ¯ä¸ªSqlSessionä¸­æŒæœ‰äº†Executorï¼Œæ¯ä¸ªExecutorä¸­æœ‰ä¸€ä¸ªLocalCacheã€‚å½“ç”¨æˆ·å‘èµ·æŸ¥è¯¢æ—¶ï¼ŒMyBatisæ ¹æ®å½“å‰æ‰§è¡Œçš„è¯­å¥ç”Ÿæˆ<code>MappedStatement</code>ï¼Œåœ¨Local Cacheè¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœç¼“å­˜å‘½ä¸­çš„è¯ï¼Œç›´æ¥è¿”å›ç»“æœç»™ç”¨æˆ·ï¼Œå¦‚æœç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„è¯ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œç»“æœå†™å…¥<code>Local Cache</code>ï¼Œæœ€åè¿”å›ç»“æœç»™ç”¨æˆ·ã€‚å…·ä½“å®ç°ç±»çš„ç±»å…³ç³»å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/d76ec5fe.jpg" srcset="/img/loading.gif" alt="img"></p>
<h3 id="ä¸€çº§ç¼“å­˜é…ç½®"><a href="#ä¸€çº§ç¼“å­˜é…ç½®" class="headerlink" title="ä¸€çº§ç¼“å­˜é…ç½®"></a>ä¸€çº§ç¼“å­˜é…ç½®</h3><p>æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨MyBatisä¸€çº§ç¼“å­˜ã€‚å¼€å‘è€…åªéœ€åœ¨MyBatisçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹è¯­å¥ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸€çº§ç¼“å­˜ã€‚å…±æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œ<code>SESSION</code>æˆ–è€…<code>STATEMENT</code>ï¼Œé»˜è®¤æ˜¯<code>SESSION</code>çº§åˆ«ï¼Œå³åœ¨ä¸€ä¸ªMyBatisä¼šè¯ä¸­æ‰§è¡Œçš„æ‰€æœ‰è¯­å¥ï¼Œéƒ½ä¼šå…±äº«è¿™ä¸€ä¸ªç¼“å­˜ã€‚ä¸€ç§æ˜¯<code>STATEMENT</code>çº§åˆ«ï¼Œå¯ä»¥ç†è§£ä¸ºç¼“å­˜åªå¯¹å½“å‰æ‰§è¡Œçš„è¿™ä¸€ä¸ª<code>Statement</code>æœ‰æ•ˆã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"localCacheScope"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"SESSION"</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="ä¸€çº§ç¼“å­˜å®éªŒ"><a href="#ä¸€çº§ç¼“å­˜å®éªŒ" class="headerlink" title="ä¸€çº§ç¼“å­˜å®éªŒ"></a>ä¸€çº§ç¼“å­˜å®éªŒ</h3><p>æ¥ä¸‹æ¥é€šè¿‡å®éªŒï¼Œäº†è§£MyBatisä¸€çº§ç¼“å­˜çš„æ•ˆæœï¼Œæ¯ä¸ªå•å…ƒæµ‹è¯•åéƒ½è¯·æ¢å¤è¢«ä¿®æ”¹çš„æ•°æ®ã€‚</p>
<p>é¦–å…ˆæ˜¯åˆ›å»ºç¤ºä¾‹è¡¨studentï¼Œåˆ›å»ºå¯¹åº”çš„POJOç±»å’Œå¢æ”¹çš„æ–¹æ³•ï¼Œå…·ä½“å¯ä»¥åœ¨entityåŒ…å’ŒmapperåŒ…ä¸­æŸ¥çœ‹ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`student`</span> (<br>  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,<br>  <span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`age`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)<br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8 <span class="hljs-keyword">COLLATE</span>=utf8_bin;<br></code></pre></td></tr></table></figure>

<p>åœ¨ä»¥ä¸‹å®éªŒä¸­ï¼Œidä¸º1çš„å­¦ç”Ÿåç§°æ˜¯å‡¯ä¼¦ã€‚</p>
<h4 id="å®éªŒ1"><a href="#å®éªŒ1" class="headerlink" title="å®éªŒ1"></a>å®éªŒ1</h4><p>å¼€å¯ä¸€çº§ç¼“å­˜ï¼ŒèŒƒå›´ä¸ºä¼šè¯çº§åˆ«ï¼Œè°ƒç”¨ä¸‰æ¬¡<code>getStudentById</code>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getStudentById</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSession sqlSession = factory.openSession(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// è‡ªåŠ¨æäº¤äº‹åŠ¡</span><br>        StudentMapper studentMapper = sqlSession.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        System.out.println(studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        System.out.println(studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        System.out.println(studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/9e996384.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡çœŸæ­£æŸ¥è¯¢äº†æ•°æ®åº“ï¼Œåç»­çš„æŸ¥è¯¢ä½¿ç”¨äº†ä¸€çº§ç¼“å­˜ã€‚</p>
<h4 id="å®éªŒ2"><a href="#å®éªŒ2" class="headerlink" title="å®éªŒ2"></a>å®éªŒ2</h4><p>å¢åŠ äº†å¯¹æ•°æ®åº“çš„ä¿®æ”¹æ“ä½œï¼ŒéªŒè¯åœ¨ä¸€æ¬¡æ•°æ®åº“ä¼šè¯ä¸­ï¼Œå¦‚æœå¯¹æ•°æ®åº“å‘ç”Ÿäº†ä¿®æ”¹æ“ä½œï¼Œä¸€çº§ç¼“å­˜æ˜¯å¦ä¼šå¤±æ•ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addStudent</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSession sqlSession = factory.openSession(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// è‡ªåŠ¨æäº¤äº‹åŠ¡</span><br>        StudentMapper studentMapper = sqlSession.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        System.out.println(studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        System.out.println(<span class="hljs-string">"å¢åŠ äº†"</span> + studentMapper.addStudent(buildStudent()) + <span class="hljs-string">"ä¸ªå­¦ç”Ÿ"</span>);<br>        System.out.println(studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        sqlSession.close();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/fb6a78e0.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¿®æ”¹æ“ä½œåæ‰§è¡Œçš„ç›¸åŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢äº†æ•°æ®åº“ï¼Œ<strong>ä¸€çº§ç¼“å­˜å¤±æ•ˆ</strong>ã€‚</p>
<h4 id="å®éªŒ3"><a href="#å®éªŒ3" class="headerlink" title="å®éªŒ3"></a>å®éªŒ3</h4><p>å¼€å¯ä¸¤ä¸ª<code>SqlSession</code>ï¼Œåœ¨<code>sqlSession1</code>ä¸­æŸ¥è¯¢æ•°æ®ï¼Œä½¿ä¸€çº§ç¼“å­˜ç”Ÿæ•ˆï¼Œåœ¨<code>sqlSession2</code>ä¸­æ›´æ–°æ•°æ®åº“ï¼ŒéªŒè¯ä¸€çº§ç¼“å­˜åªåœ¨æ•°æ®åº“ä¼šè¯å†…éƒ¨å…±äº«ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLocalCacheScope</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSession sqlSession1 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        SqlSession sqlSession2 = factory.openSession(<span class="hljs-keyword">true</span>); <br><br>        StudentMapper studentMapper = sqlSession1.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        StudentMapper studentMapper2 = sqlSession2.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>        System.out.println(<span class="hljs-string">"studentMapperè¯»å–æ•°æ®: "</span> + studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        System.out.println(<span class="hljs-string">"studentMapperè¯»å–æ•°æ®: "</span> + studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        System.out.println(<span class="hljs-string">"studentMapper2æ›´æ–°äº†"</span> + studentMapper2.updateStudentName(<span class="hljs-string">"å°å²‘"</span>,<span class="hljs-number">1</span>) + <span class="hljs-string">"ä¸ªå­¦ç”Ÿçš„æ•°æ®"</span>);<br>        System.out.println(<span class="hljs-string">"studentMapperè¯»å–æ•°æ®: "</span> + studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        System.out.println(<span class="hljs-string">"studentMapper2è¯»å–æ•°æ®: "</span> + studentMapper2.getStudentById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/f480ac76.jpg" srcset="/img/loading.gif" alt="img"></p>
<p><code>sqlSession2</code>æ›´æ–°äº†idä¸º1çš„å­¦ç”Ÿçš„å§“åï¼Œä»å‡¯ä¼¦æ”¹ä¸ºäº†å°å²‘ï¼Œä½†session1ä¹‹åçš„æŸ¥è¯¢ä¸­ï¼Œidä¸º1çš„å­¦ç”Ÿçš„åå­—è¿˜æ˜¯å‡¯ä¼¦ï¼Œå‡ºç°äº†è„æ•°æ®ï¼Œä¹Ÿè¯æ˜äº†ä¹‹å‰çš„è®¾æƒ³ï¼Œä¸€çº§ç¼“å­˜åªåœ¨æ•°æ®åº“ä¼šè¯å†…éƒ¨å…±äº«ã€‚</p>
<h3 id="ä¸€çº§ç¼“å­˜å·¥ä½œæµç¨‹-amp-æºç åˆ†æ"><a href="#ä¸€çº§ç¼“å­˜å·¥ä½œæµç¨‹-amp-æºç åˆ†æ" class="headerlink" title="ä¸€çº§ç¼“å­˜å·¥ä½œæµç¨‹&amp;æºç åˆ†æ"></a>ä¸€çº§ç¼“å­˜å·¥ä½œæµç¨‹&amp;æºç åˆ†æ</h3><p>é‚£ä¹ˆï¼Œä¸€çº§ç¼“å­˜çš„å·¥ä½œæµç¨‹æ˜¯æ€æ ·çš„å‘¢ï¼Ÿæˆ‘ä»¬ä»æºç å±‚é¢æ¥å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<h4 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h4><p>ä¸€çº§ç¼“å­˜æ‰§è¡Œçš„æ—¶åºå›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/bb851700.png" srcset="/img/loading.gif" alt="img"></p>
<h4 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><p>æ¥ä¸‹æ¥å°†å¯¹MyBatisæŸ¥è¯¢ç›¸å…³çš„æ ¸å¿ƒç±»å’Œä¸€çº§ç¼“å­˜çš„æºç è¿›è¡Œèµ°è¯»ã€‚è¿™å¯¹åé¢å­¦ä¹ äºŒçº§ç¼“å­˜ä¹Ÿæœ‰å¸®åŠ©ã€‚</p>
<p><strong>SqlSession</strong>ï¼š å¯¹å¤–æä¾›äº†ç”¨æˆ·å’Œæ•°æ®åº“ä¹‹é—´äº¤äº’éœ€è¦çš„æ‰€æœ‰æ–¹æ³•ï¼Œéšè—äº†åº•å±‚çš„ç»†èŠ‚ã€‚é»˜è®¤å®ç°ç±»æ˜¯<code>DefaultSqlSession</code>ã€‚</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/ba96bc7f.jpg" srcset="/img/loading.gif" alt="img"></p>
<p><strong>Executor</strong>ï¼š <code>SqlSession</code>å‘ç”¨æˆ·æä¾›æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ï¼Œä½†å’Œæ•°æ®åº“æ“ä½œæœ‰å…³çš„èŒè´£éƒ½ä¼šå§”æ‰˜ç»™Executorã€‚</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/ef5e0eb3.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒExecutoræœ‰è‹¥å¹²ä¸ªå®ç°ç±»ï¼Œä¸ºExecutorèµ‹äºˆäº†ä¸åŒçš„èƒ½åŠ›ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®ç±»åï¼Œè‡ªè¡Œå­¦ä¹ æ¯ä¸ªç±»çš„åŸºæœ¬ä½œç”¨ã€‚</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/83326eb3.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>åœ¨ä¸€çº§ç¼“å­˜çš„æºç åˆ†æä¸­ï¼Œä¸»è¦å­¦ä¹ <code>BaseExecutor</code>çš„å†…éƒ¨å®ç°ã€‚</p>
<p><strong>BaseExecutor</strong>ï¼š <code>BaseExecutor</code>æ˜¯ä¸€ä¸ªå®ç°äº†Executoræ¥å£çš„æŠ½è±¡ç±»ï¼Œå®šä¹‰è‹¥å¹²æŠ½è±¡æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼ŒæŠŠå…·ä½“çš„æ“ä½œå§”æ‰˜ç»™å­ç±»è¿›è¡Œæ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> List&lt;BatchResult&gt; <span class="hljs-title">doFlushStatements</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> &lt;E&gt; <span class="hljs-function">Cursor&lt;E&gt; <span class="hljs-title">doQueryCursor</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br></code></pre></td></tr></table></figure>

<p>åœ¨ä¸€çº§ç¼“å­˜çš„ä»‹ç»ä¸­æåˆ°å¯¹<code>Local Cache</code>çš„æŸ¥è¯¢å’Œå†™å…¥æ˜¯åœ¨<code>Executor</code>å†…éƒ¨å®Œæˆçš„ã€‚åœ¨é˜…è¯»<code>BaseExecutor</code>çš„ä»£ç åå‘ç°<code>Local Cache</code>æ˜¯<code>BaseExecutor</code>å†…éƒ¨çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Executor</span> </span>&#123;<br><span class="hljs-keyword">protected</span> ConcurrentLinkedQueue&lt;DeferredLoad&gt; deferredLoads;<br><span class="hljs-keyword">protected</span> PerpetualCache localCache;<br></code></pre></td></tr></table></figure>

<p><strong>Cache</strong>ï¼š MyBatisä¸­çš„Cacheæ¥å£ï¼Œæä¾›äº†å’Œç¼“å­˜ç›¸å…³çš„æœ€åŸºæœ¬çš„æ“ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/793031d0.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>æœ‰è‹¥å¹²ä¸ªå®ç°ç±»ï¼Œä½¿ç”¨è£…é¥°å™¨æ¨¡å¼äº’ç›¸ç»„è£…ï¼Œæä¾›ä¸°å¯Œçš„æ“æ§ç¼“å­˜çš„èƒ½åŠ›ï¼Œéƒ¨åˆ†å®ç°ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/cdb21712.jpg" srcset="/img/loading.gif" alt="img"></p>
<p><code>BaseExecutor</code>æˆå‘˜å˜é‡ä¹‹ä¸€çš„<code>PerpetualCache</code>ï¼Œæ˜¯å¯¹Cacheæ¥å£æœ€åŸºæœ¬çš„å®ç°ï¼Œå…¶å®ç°éå¸¸ç®€å•ï¼Œå†…éƒ¨æŒæœ‰HashMapï¼Œå¯¹ä¸€çº§ç¼“å­˜çš„æ“ä½œå®åˆ™æ˜¯å¯¹HashMapçš„æ“ä½œã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerpetualCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Cache</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> String id;<br>  <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; cache = <span class="hljs-keyword">new</span> HashMap&lt;Object, Object&gt;();<br></code></pre></td></tr></table></figure>

<p>åœ¨é˜…è¯»ç›¸å…³æ ¸å¿ƒç±»ä»£ç åï¼Œä»æºä»£ç å±‚é¢å¯¹ä¸€çº§ç¼“å­˜å·¥ä½œä¸­æ¶‰åŠåˆ°çš„ç›¸å…³ä»£ç ï¼Œå‡ºäºç¯‡å¹…çš„è€ƒè™‘ï¼Œå¯¹æºç åšé€‚å½“åˆ å‡ï¼Œè¯»è€…æœ‹å‹å¯ä»¥ç»“åˆæœ¬æ–‡ï¼Œåç»­è¿›è¡Œæ›´è¯¦ç»†çš„å­¦ä¹ ã€‚</p>
<p>ä¸ºæ‰§è¡Œå’Œæ•°æ®åº“çš„äº¤äº’ï¼Œé¦–å…ˆéœ€è¦åˆå§‹åŒ–<code>SqlSession</code>ï¼Œé€šè¿‡<code>DefaultSqlSessionFactory</code>å¼€å¯<code>SqlSession</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> SqlSession <span class="hljs-title">openSessionFromDataSource</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level, <span class="hljs-keyword">boolean</span> autoCommit)</span> </span>&#123;<br>    ............<br>    <span class="hljs-keyword">final</span> Executor executor = configuration.newExecutor(tx, execType);     <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultSqlSession(configuration, executor, autoCommit);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨åˆå§‹åŒ–<code>SqlSesion</code>æ—¶ï¼Œä¼šä½¿ç”¨<code>Configuration</code>ç±»åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„<code>Executor</code>ï¼Œä½œä¸º<code>DefaultSqlSession</code>æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œåˆ›å»ºExecutorä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Executor <span class="hljs-title">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> </span>&#123;<br>    executorType = executorType == <span class="hljs-keyword">null</span> ? defaultExecutorType : executorType;<br>    executorType = executorType == <span class="hljs-keyword">null</span> ? ExecutorType.SIMPLE : executorType;<br>    Executor executor;<br>    <span class="hljs-keyword">if</span> (ExecutorType.BATCH == executorType) &#123;<br>      executor = <span class="hljs-keyword">new</span> BatchExecutor(<span class="hljs-keyword">this</span>, transaction);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ExecutorType.REUSE == executorType) &#123;<br>      executor = <span class="hljs-keyword">new</span> ReuseExecutor(<span class="hljs-keyword">this</span>, transaction);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      executor = <span class="hljs-keyword">new</span> SimpleExecutor(<span class="hljs-keyword">this</span>, transaction);<br>    &#125;<br>    <span class="hljs-comment">// å°¤å…¶å¯ä»¥æ³¨æ„è¿™é‡Œï¼Œå¦‚æœäºŒçº§ç¼“å­˜å¼€å…³å¼€å¯çš„è¯ï¼Œæ˜¯ä½¿ç”¨CahingExecutorè£…é¥°BaseExecutorçš„å­ç±»</span><br>    <span class="hljs-keyword">if</span> (cacheEnabled) &#123;<br>      executor = <span class="hljs-keyword">new</span> CachingExecutor(executor);                      <br>    &#125;<br>    executor = (Executor) interceptorChain.pluginAll(executor);<br>    <span class="hljs-keyword">return</span> executor;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>SqlSession</code>åˆ›å»ºå®Œæ¯•åï¼Œæ ¹æ®Statmentçš„ä¸åŒç±»å‹ï¼Œä¼šè¿›å…¥<code>SqlSession</code>çš„ä¸åŒæ–¹æ³•ä¸­ï¼Œå¦‚æœæ˜¯<code>Select</code>è¯­å¥çš„è¯ï¼Œæœ€åä¼šæ‰§è¡Œåˆ°<code>SqlSession</code>çš„<code>selectList</code>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span> </span>&#123;<br>      MappedStatement ms = configuration.getMappedStatement(statement);<br>      <span class="hljs-keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>SqlSession</code>æŠŠå…·ä½“çš„æŸ¥è¯¢èŒè´£å§”æ‰˜ç»™äº†Executorã€‚å¦‚æœåªå¼€å¯äº†ä¸€çº§ç¼“å­˜çš„è¯ï¼Œé¦–å…ˆä¼šè¿›å…¥<code>BaseExecutor</code>çš„<code>query</code>æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    BoundSql boundSql = ms.getBoundSql(parameter);<br>    CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);<br>    <span class="hljs-keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œä¼šå…ˆæ ¹æ®ä¼ å…¥çš„å‚æ•°ç”ŸæˆCacheKeyï¼Œè¿›å…¥è¯¥æ–¹æ³•æŸ¥çœ‹CacheKeyæ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">CacheKey cacheKey = <span class="hljs-keyword">new</span> CacheKey();<br>cacheKey.update(ms.getId());<br>cacheKey.update(rowBounds.getOffset());<br>cacheKey.update(rowBounds.getLimit());<br>cacheKey.update(boundSql.getSql());<br><span class="hljs-comment">//åé¢æ˜¯updateäº†sqlä¸­å¸¦çš„å‚æ•°</span><br>cacheKey.update(value);<br></code></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°çš„ä»£ç ä¸­ï¼Œå°†<code>MappedStatement</code>çš„Idã€SQLçš„offsetã€SQLçš„limitã€SQLæœ¬èº«ä»¥åŠSQLä¸­çš„å‚æ•°ä¼ å…¥äº†CacheKeyè¿™ä¸ªç±»ï¼Œæœ€ç»ˆæ„æˆCacheKeyã€‚ä»¥ä¸‹æ˜¯è¿™ä¸ªç±»çš„å†…éƒ¨ç»“æ„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEFAULT_MULTIPLYER = <span class="hljs-number">37</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEFAULT_HASHCODE = <span class="hljs-number">17</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> multiplier;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> hashcode;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> checksum;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count;<br><span class="hljs-keyword">private</span> List&lt;Object&gt; updateList;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CacheKey</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.hashcode = DEFAULT_HASHCODE;<br>    <span class="hljs-keyword">this</span>.multiplier = DEFAULT_MULTIPLYER;<br>    <span class="hljs-keyword">this</span>.count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">this</span>.updateList = <span class="hljs-keyword">new</span> ArrayList&lt;Object&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæ˜¯æˆå‘˜å˜é‡å’Œæ„é€ å‡½æ•°ï¼Œæœ‰ä¸€ä¸ªåˆå§‹çš„<code>hachcode</code>å’Œä¹˜æ•°ï¼ŒåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ªå†…éƒ¨çš„<code>updatelist</code>ã€‚åœ¨<code>CacheKey</code>çš„<code>update</code>æ–¹æ³•ä¸­ï¼Œä¼šè¿›è¡Œä¸€ä¸ª<code>hashcode</code>å’Œ<code>checksum</code>çš„è®¡ç®—ï¼ŒåŒæ—¶æŠŠä¼ å…¥çš„å‚æ•°æ·»åŠ è¿›<code>updatelist</code>ä¸­ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> baseHashCode = object == <span class="hljs-keyword">null</span> ? <span class="hljs-number">1</span> : ArrayUtil.hashCode(object); <br>    count++;<br>    checksum += baseHashCode;<br>    baseHashCode *= count;<br>    hashcode = multiplier * hashcode + baseHashCode;<br>    <br>    updateList.add(object);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åŒæ—¶é‡å†™äº†<code>CacheKey</code>çš„<code>equals</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>    .............<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; updateList.size(); i++) &#123;<br>      Object thisObject = updateList.get(i);<br>      Object thatObject = cacheKey.updateList.get(i);<br>      <span class="hljs-keyword">if</span> (!ArrayUtil.equals(thisObject, thatObject)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é™¤å»hashcodeã€checksumå’Œcountçš„æ¯”è¾ƒå¤–ï¼Œåªè¦updatelistä¸­çš„å…ƒç´ ä¸€ä¸€å¯¹åº”ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºæ˜¯CacheKeyç›¸ç­‰ã€‚åªè¦ä¸¤æ¡SQLçš„ä¸‹åˆ—äº”ä¸ªå€¼ç›¸åŒï¼Œå³å¯ä»¥è®¤ä¸ºæ˜¯ç›¸åŒçš„SQLã€‚</p>
<blockquote>
<p>Statement Id + Offset + Limmit + Sql + Params</p>
</blockquote>
<p>BaseExecutorçš„queryæ–¹æ³•ç»§ç»­å¾€ä¸‹èµ°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">list = resultHandler == <span class="hljs-keyword">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">if</span> (list != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// è¿™ä¸ªä¸»è¦æ˜¯å¤„ç†å­˜å‚¨è¿‡ç¨‹ç”¨çš„ã€‚</span><br>    handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>    list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¦‚æœæŸ¥ä¸åˆ°çš„è¯ï¼Œå°±ä»æ•°æ®åº“æŸ¥ï¼Œåœ¨<code>queryFromDatabase</code>ä¸­ï¼Œä¼šå¯¹<code>localcache</code>è¿›è¡Œå†™å…¥ã€‚</p>
<p>åœ¨<code>query</code>æ–¹æ³•æ‰§è¡Œçš„æœ€åï¼Œä¼šåˆ¤æ–­ä¸€çº§ç¼“å­˜çº§åˆ«æ˜¯å¦æ˜¯<code>STATEMENT</code>çº§åˆ«ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±æ¸…ç©ºç¼“å­˜ï¼Œè¿™ä¹Ÿå°±æ˜¯<code>STATEMENT</code>çº§åˆ«çš„ä¸€çº§ç¼“å­˜æ— æ³•å…±äº«<code>localCache</code>çš„åŸå› ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;<br>        clearLocalCache();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨æºç åˆ†æçš„æœ€åï¼Œæˆ‘ä»¬ç¡®è®¤ä¸€ä¸‹ï¼Œå¦‚æœæ˜¯<code>insert/delete/update</code>æ–¹æ³•ï¼Œç¼“å­˜å°±ä¼šåˆ·æ–°çš„åŸå› ã€‚</p>
<p><code>SqlSession</code>çš„<code>insert</code>æ–¹æ³•å’Œ<code>delete</code>æ–¹æ³•ï¼Œéƒ½ä¼šç»Ÿä¸€èµ°<code>update</code>çš„æµç¨‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(String statement, Object parameter)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> update(statement, parameter);<br>  &#125;<br>   <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">delete</span><span class="hljs-params">(String statement)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> update(statement, <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>update</code>æ–¹æ³•ä¹Ÿæ˜¯å§”æ‰˜ç»™äº†<code>Executor</code>æ‰§è¡Œã€‚<code>BaseExecutor</code>çš„æ‰§è¡Œæ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">"executing an update"</span>).object(ms.getId());<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExecutorException(<span class="hljs-string">"Executor was closed."</span>);<br>    &#125;<br>    clearLocalCache();<br>    <span class="hljs-keyword">return</span> doUpdate(ms, parameter);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¯æ¬¡æ‰§è¡Œ<code>update</code>å‰éƒ½ä¼šæ¸…ç©º<code>localCache</code>ã€‚</p>
<p>è‡³æ­¤ï¼Œä¸€çº§ç¼“å­˜çš„å·¥ä½œæµç¨‹è®²è§£ä»¥åŠæºç åˆ†æå®Œæ¯•ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li>MyBatisä¸€çº§ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸå’ŒSqlSessionä¸€è‡´ã€‚</li>
<li>MyBatisä¸€çº§ç¼“å­˜å†…éƒ¨è®¾è®¡ç®€å•ï¼Œåªæ˜¯ä¸€ä¸ªæ²¡æœ‰å®¹é‡é™å®šçš„HashMapï¼Œåœ¨ç¼“å­˜çš„åŠŸèƒ½æ€§ä¸Šæœ‰æ‰€æ¬ ç¼ºã€‚</li>
<li>MyBatisçš„ä¸€çº§ç¼“å­˜æœ€å¤§èŒƒå›´æ˜¯SqlSessionå†…éƒ¨ï¼Œæœ‰å¤šä¸ªSqlSessionæˆ–è€…åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸‹ï¼Œæ•°æ®åº“å†™æ“ä½œä¼šå¼•èµ·è„æ•°æ®ï¼Œå»ºè®®è®¾å®šç¼“å­˜çº§åˆ«ä¸ºStatementã€‚</li>
</ol>
<h2 id="äºŒçº§ç¼“å­˜"><a href="#äºŒçº§ç¼“å­˜" class="headerlink" title="äºŒçº§ç¼“å­˜"></a>äºŒçº§ç¼“å­˜</h2><h3 id="äºŒçº§ç¼“å­˜ä»‹ç»"><a href="#äºŒçº§ç¼“å­˜ä»‹ç»" class="headerlink" title="äºŒçº§ç¼“å­˜ä»‹ç»"></a>äºŒçº§ç¼“å­˜ä»‹ç»</h3><p>åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ä¸€çº§ç¼“å­˜ä¸­ï¼Œå…¶æœ€å¤§çš„å…±äº«èŒƒå›´å°±æ˜¯ä¸€ä¸ªSqlSessionå†…éƒ¨ï¼Œå¦‚æœå¤šä¸ªSqlSessionä¹‹é—´éœ€è¦å…±äº«ç¼“å­˜ï¼Œåˆ™éœ€è¦ä½¿ç”¨åˆ°äºŒçº§ç¼“å­˜ã€‚å¼€å¯äºŒçº§ç¼“å­˜åï¼Œä¼šä½¿ç”¨CachingExecutorè£…é¥°Executorï¼Œè¿›å…¥ä¸€çº§ç¼“å­˜çš„æŸ¥è¯¢æµç¨‹å‰ï¼Œå…ˆåœ¨CachingExecutorè¿›è¡ŒäºŒçº§ç¼“å­˜çš„æŸ¥è¯¢ï¼Œå…·ä½“çš„å·¥ä½œæµç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/28399eba.png" srcset="/img/loading.gif" alt="img"></p>
<p>äºŒçº§ç¼“å­˜å¼€å¯åï¼ŒåŒä¸€ä¸ªnamespaceä¸‹çš„æ‰€æœ‰æ“ä½œè¯­å¥ï¼Œéƒ½å½±å“ç€åŒä¸€ä¸ªCacheï¼Œå³äºŒçº§ç¼“å­˜è¢«å¤šä¸ªSqlSessionå…±äº«ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€çš„å˜é‡ã€‚</p>
<p>å½“å¼€å¯ç¼“å­˜åï¼Œæ•°æ®çš„æŸ¥è¯¢æ‰§è¡Œçš„æµç¨‹å°±æ˜¯ äºŒçº§ç¼“å­˜ -&gt; ä¸€çº§ç¼“å­˜ -&gt; æ•°æ®åº“ã€‚</p>
<h3 id="äºŒçº§ç¼“å­˜é…ç½®"><a href="#äºŒçº§ç¼“å­˜é…ç½®" class="headerlink" title="äºŒçº§ç¼“å­˜é…ç½®"></a>äºŒçº§ç¼“å­˜é…ç½®</h3><p>è¦æ­£ç¡®çš„ä½¿ç”¨äºŒçº§ç¼“å­˜ï¼Œéœ€å®Œæˆå¦‚ä¸‹é…ç½®çš„ã€‚</p>
<ol>
<li>åœ¨MyBatisçš„é…ç½®æ–‡ä»¶ä¸­å¼€å¯äºŒçº§ç¼“å­˜ã€‚</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<ol>
<li>åœ¨MyBatisçš„æ˜ å°„XMLä¸­é…ç½®cacheæˆ–è€… cache-ref ã€‚</li>
</ol>
<p>cacheæ ‡ç­¾ç”¨äºå£°æ˜è¿™ä¸ªnamespaceä½¿ç”¨äºŒçº§ç¼“å­˜ï¼Œå¹¶ä¸”å¯ä»¥è‡ªå®šä¹‰é…ç½®ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cache</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>type</code>ï¼šcacheä½¿ç”¨çš„ç±»å‹ï¼Œé»˜è®¤æ˜¯<code>PerpetualCache</code>ï¼Œè¿™åœ¨ä¸€çº§ç¼“å­˜ä¸­æåˆ°è¿‡ã€‚</li>
<li><code>eviction</code>ï¼š å®šä¹‰å›æ”¶çš„ç­–ç•¥ï¼Œå¸¸è§çš„æœ‰FIFOï¼ŒLRUã€‚</li>
<li><code>flushInterval</code>ï¼š é…ç½®ä¸€å®šæ—¶é—´è‡ªåŠ¨åˆ·æ–°ç¼“å­˜ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</li>
<li><code>size</code>ï¼š æœ€å¤šç¼“å­˜å¯¹è±¡çš„ä¸ªæ•°ã€‚</li>
<li><code>readOnly</code>ï¼š æ˜¯å¦åªè¯»ï¼Œè‹¥é…ç½®å¯è¯»å†™ï¼Œåˆ™éœ€è¦å¯¹åº”çš„å®ä½“ç±»èƒ½å¤Ÿåºåˆ—åŒ–ã€‚</li>
<li><code>blocking</code>ï¼š è‹¥ç¼“å­˜ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„keyï¼Œæ˜¯å¦ä¼šä¸€ç›´blockingï¼Œç›´åˆ°æœ‰å¯¹åº”çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚</li>
</ul>
<p><code>cache-ref</code>ä»£è¡¨å¼•ç”¨åˆ«çš„å‘½åç©ºé—´çš„Cacheé…ç½®ï¼Œä¸¤ä¸ªå‘½åç©ºé—´çš„æ“ä½œä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªCacheã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cache-ref</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"mapper.StudentMapper"</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="äºŒçº§ç¼“å­˜å®éªŒ"><a href="#äºŒçº§ç¼“å­˜å®éªŒ" class="headerlink" title="äºŒçº§ç¼“å­˜å®éªŒ"></a>äºŒçº§ç¼“å­˜å®éªŒ</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡å®éªŒï¼Œäº†è§£MyBatisäºŒçº§ç¼“å­˜åœ¨ä½¿ç”¨ä¸Šçš„ä¸€äº›ç‰¹ç‚¹ã€‚</p>
<p>åœ¨æœ¬å®éªŒä¸­ï¼Œidä¸º1çš„å­¦ç”Ÿåç§°åˆå§‹åŒ–ä¸ºç‚¹ç‚¹ã€‚</p>
<h4 id="å®éªŒ1-1"><a href="#å®éªŒ1-1" class="headerlink" title="å®éªŒ1"></a>å®éªŒ1</h4><p>æµ‹è¯•äºŒçº§ç¼“å­˜æ•ˆæœï¼Œä¸æäº¤äº‹åŠ¡ï¼Œ<code>sqlSession1</code>æŸ¥è¯¢å®Œæ•°æ®åï¼Œ<code>sqlSession2</code>ç›¸åŒçš„æŸ¥è¯¢æ˜¯å¦ä¼šä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCacheWithoutCommitOrClose</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSession sqlSession1 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        SqlSession sqlSession2 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        <br>        StudentMapper studentMapper = sqlSession1.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        StudentMapper studentMapper2 = sqlSession2.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>        System.out.println(<span class="hljs-string">"studentMapperè¯»å–æ•°æ®: "</span> + studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        System.out.println(<span class="hljs-string">"studentMapper2è¯»å–æ•°æ®: "</span> + studentMapper2.getStudentById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/71e2bfdc.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“<code>sqlsession</code>æ²¡æœ‰è°ƒç”¨<code>commit()</code>æ–¹æ³•æ—¶ï¼ŒäºŒçº§ç¼“å­˜å¹¶æ²¡æœ‰èµ·åˆ°ä½œç”¨ã€‚</p>
<h4 id="å®éªŒ2-1"><a href="#å®éªŒ2-1" class="headerlink" title="å®éªŒ2"></a>å®éªŒ2</h4><p>æµ‹è¯•äºŒçº§ç¼“å­˜æ•ˆæœï¼Œå½“æäº¤äº‹åŠ¡æ—¶ï¼Œ<code>sqlSession1</code>æŸ¥è¯¢å®Œæ•°æ®åï¼Œ<code>sqlSession2</code>ç›¸åŒçš„æŸ¥è¯¢æ˜¯å¦ä¼šä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCacheWithCommitOrClose</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSession sqlSession1 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        SqlSession sqlSession2 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        <br>        StudentMapper studentMapper = sqlSession1.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        StudentMapper studentMapper2 = sqlSession2.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>        System.out.println(<span class="hljs-string">"studentMapperè¯»å–æ•°æ®: "</span> + studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        sqlSession1.commit();<br>        System.out.println(<span class="hljs-string">"studentMapper2è¯»å–æ•°æ®: "</span> + studentMapper2.getStudentById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/f366f34e.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>ä»å›¾ä¸Šå¯çŸ¥ï¼Œ<code>sqlsession2</code>çš„æŸ¥è¯¢ï¼Œä½¿ç”¨äº†ç¼“å­˜ï¼Œç¼“å­˜çš„å‘½ä¸­ç‡æ˜¯0.5ã€‚</p>
<h4 id="å®éªŒ3-1"><a href="#å®éªŒ3-1" class="headerlink" title="å®éªŒ3"></a>å®éªŒ3</h4><p>æµ‹è¯•<code>update</code>æ“ä½œæ˜¯å¦ä¼šåˆ·æ–°è¯¥<code>namespace</code>ä¸‹çš„äºŒçº§ç¼“å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCacheWithUpdate</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSession sqlSession1 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        SqlSession sqlSession2 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        SqlSession sqlSession3 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        <br>        StudentMapper studentMapper = sqlSession1.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        StudentMapper studentMapper2 = sqlSession2.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        StudentMapper studentMapper3 = sqlSession3.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        <br>        System.out.println(<span class="hljs-string">"studentMapperè¯»å–æ•°æ®: "</span> + studentMapper.getStudentById(<span class="hljs-number">1</span>));<br>        sqlSession1.commit();<br>        System.out.println(<span class="hljs-string">"studentMapper2è¯»å–æ•°æ®: "</span> + studentMapper2.getStudentById(<span class="hljs-number">1</span>));<br>        <br>        studentMapper3.updateStudentName(<span class="hljs-string">"æ–¹æ–¹"</span>,<span class="hljs-number">1</span>);<br>        sqlSession3.commit();<br>        System.out.println(<span class="hljs-string">"studentMapper2è¯»å–æ•°æ®: "</span> + studentMapper2.getStudentById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/3ad93c3a.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>sqlSession3</code>æ›´æ–°æ•°æ®åº“ï¼Œå¹¶æäº¤äº‹åŠ¡åï¼Œ<code>sqlsession2</code>çš„<code>StudentMapper namespace</code>ä¸‹çš„æŸ¥è¯¢èµ°äº†æ•°æ®åº“ï¼Œæ²¡æœ‰èµ°Cacheã€‚</p>
<h4 id="å®éªŒ4"><a href="#å®éªŒ4" class="headerlink" title="å®éªŒ4"></a>å®éªŒ4</h4><p>éªŒè¯MyBatisçš„äºŒçº§ç¼“å­˜ä¸é€‚åº”ç”¨äºæ˜ å°„æ–‡ä»¶ä¸­å­˜åœ¨å¤šè¡¨æŸ¥è¯¢çš„æƒ…å†µã€‚</p>
<p>é€šå¸¸æˆ‘ä»¬ä¼šä¸ºæ¯ä¸ªå•è¡¨åˆ›å»ºå•ç‹¬çš„æ˜ å°„æ–‡ä»¶ï¼Œç”±äºMyBatisçš„äºŒçº§ç¼“å­˜æ˜¯åŸºäº<code>namespace</code>çš„ï¼Œå¤šè¡¨æŸ¥è¯¢è¯­å¥æ‰€åœ¨çš„<code>namspace</code>æ— æ³•æ„Ÿåº”åˆ°å…¶ä»–<code>namespace</code>ä¸­çš„è¯­å¥å¯¹å¤šè¡¨æŸ¥è¯¢ä¸­æ¶‰åŠçš„è¡¨è¿›è¡Œçš„ä¿®æ”¹ï¼Œå¼•å‘è„æ•°æ®é—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCacheWithDiffererntNamespace</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSession sqlSession1 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        SqlSession sqlSession2 = factory.openSession(<span class="hljs-keyword">true</span>); <br>        SqlSession sqlSession3 = factory.openSession(<span class="hljs-keyword">true</span>); <br>    <br>        StudentMapper studentMapper = sqlSession1.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        StudentMapper studentMapper2 = sqlSession2.getMapper(StudentMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        ClassMapper classMapper = sqlSession3.getMapper(ClassMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        <br>        System.out.println(<span class="hljs-string">"studentMapperè¯»å–æ•°æ®: "</span> + studentMapper.getStudentByIdWithClassInfo(<span class="hljs-number">1</span>));<br>        sqlSession1.close();<br>        System.out.println(<span class="hljs-string">"studentMapper2è¯»å–æ•°æ®: "</span> + studentMapper2.getStudentByIdWithClassInfo(<span class="hljs-number">1</span>));<br><br>        classMapper.updateClassName(<span class="hljs-string">"ç‰¹è‰²ä¸€ç­"</span>,<span class="hljs-number">1</span>);<br>        sqlSession3.commit();<br>        System.out.println(<span class="hljs-string">"studentMapper2è¯»å–æ•°æ®: "</span> + studentMapper2.getStudentByIdWithClassInfo(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/5265ed97.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸¤å¼ æ–°çš„è¡¨ï¼Œä¸€å¼ classï¼Œä¸€å¼ classroomã€‚classä¸­ä¿å­˜äº†ç­çº§çš„idå’Œç­çº§åï¼Œclassroomä¸­ä¿å­˜äº†ç­çº§idå’Œå­¦ç”Ÿidã€‚æˆ‘ä»¬åœ¨<code>StudentMapper</code>ä¸­å¢åŠ äº†ä¸€ä¸ªæŸ¥è¯¢æ–¹æ³•<code>getStudentByIdWithClassInfo</code>ï¼Œç”¨äºæŸ¥è¯¢å­¦ç”Ÿæ‰€åœ¨çš„ç­çº§ï¼Œæ¶‰åŠåˆ°å¤šè¡¨æŸ¥è¯¢ã€‚åœ¨<code>ClassMapper</code>ä¸­æ·»åŠ äº†<code>updateClassName</code>ï¼Œæ ¹æ®ç­çº§idæ›´æ–°ç­çº§åçš„æ“ä½œã€‚</p>
<p>å½“<code>sqlsession1</code>çš„<code>studentmapper</code>æŸ¥è¯¢æ•°æ®åï¼ŒäºŒçº§ç¼“å­˜ç”Ÿæ•ˆã€‚ä¿å­˜åœ¨StudentMapperçš„namespaceä¸‹çš„cacheä¸­ã€‚å½“<code>sqlSession3</code>çš„<code>classMapper</code>çš„<code>updateClassName</code>æ–¹æ³•å¯¹classè¡¨è¿›è¡Œæ›´æ–°æ—¶ï¼Œ<code>updateClassName</code>ä¸å±äº<code>StudentMapper</code>çš„<code>namespace</code>ï¼Œæ‰€ä»¥<code>StudentMapper</code>ä¸‹çš„cacheæ²¡æœ‰æ„Ÿåº”åˆ°å˜åŒ–ï¼Œæ²¡æœ‰åˆ·æ–°ç¼“å­˜ã€‚å½“<code>StudentMapper</code>ä¸­åŒæ ·çš„æŸ¥è¯¢å†æ¬¡å‘èµ·æ—¶ï¼Œä»ç¼“å­˜ä¸­è¯»å–äº†è„æ•°æ®ã€‚</p>
<h4 id="å®éªŒ5"><a href="#å®éªŒ5" class="headerlink" title="å®éªŒ5"></a>å®éªŒ5</h4><p>ä¸ºäº†è§£å†³å®éªŒ4çš„é—®é¢˜å‘¢ï¼Œå¯ä»¥ä½¿ç”¨Cache refï¼Œè®©<code>ClassMapper</code>å¼•ç”¨<code>StudenMapper</code>å‘½åç©ºé—´ï¼Œè¿™æ ·ä¸¤ä¸ªæ˜ å°„æ–‡ä»¶å¯¹åº”çš„SQLæ“ä½œéƒ½ä½¿ç”¨çš„æ˜¯åŒä¸€å—ç¼“å­˜äº†ã€‚</p>
<p>æ‰§è¡Œç»“æœï¼š</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/a2e4c2d8.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>ä¸è¿‡è¿™æ ·åšçš„åæœæ˜¯ï¼Œç¼“å­˜çš„ç²’åº¦å˜ç²—äº†ï¼Œå¤šä¸ª<code>Mapper namespace</code>ä¸‹çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šå¯¹ç¼“å­˜ä½¿ç”¨é€ æˆå½±å“ã€‚</p>
<h3 id="äºŒçº§ç¼“å­˜æºç åˆ†æ"><a href="#äºŒçº§ç¼“å­˜æºç åˆ†æ" class="headerlink" title="äºŒçº§ç¼“å­˜æºç åˆ†æ"></a>äºŒçº§ç¼“å­˜æºç åˆ†æ</h3><p>MyBatisäºŒçº§ç¼“å­˜çš„å·¥ä½œæµç¨‹å’Œå‰æ–‡æåˆ°çš„ä¸€çº§ç¼“å­˜ç±»ä¼¼ï¼Œåªæ˜¯åœ¨ä¸€çº§ç¼“å­˜å¤„ç†å‰ï¼Œç”¨<code>CachingExecutor</code>è£…é¥°äº†<code>BaseExecutor</code>çš„å­ç±»ï¼Œåœ¨å§”æ‰˜å…·ä½“èŒè´£ç»™<code>delegate</code>ä¹‹å‰ï¼Œå®ç°äº†äºŒçº§ç¼“å­˜çš„æŸ¥è¯¢å’Œå†™å…¥åŠŸèƒ½ï¼Œå…·ä½“ç±»å…³ç³»å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/090216b1.jpg" srcset="/img/loading.gif" alt="img"></p>
<h4 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><p>æºç åˆ†æä»<code>CachingExecutor</code>çš„<code>query</code>æ–¹æ³•å±•å¼€ï¼Œæºä»£ç èµ°è¯»è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹è¾ƒå¤šï¼Œä¸èƒ½ä¸€ä¸€è¯¦ç»†è®²è§£ï¼Œè¯»è€…æœ‹å‹å¯ä»¥è‡ªè¡ŒæŸ¥è¯¢ç›¸å…³èµ„æ–™æ¥å­¦ä¹ ã€‚</p>
<p><code>CachingExecutor</code>çš„<code>query</code>æ–¹æ³•ï¼Œé¦–å…ˆä¼šä»<code>MappedStatement</code>ä¸­è·å¾—åœ¨é…ç½®åˆå§‹åŒ–æ—¶èµ‹äºˆçš„Cacheã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Cache cache = ms.getCache();<br></code></pre></td></tr></table></figure>

<p>æœ¬è´¨ä¸Šæ˜¯è£…é¥°å™¨æ¨¡å¼çš„ä½¿ç”¨ï¼Œå…·ä½“çš„è£…é¥°é“¾æ˜¯ï¼š</p>
<blockquote>
<p>SynchronizedCache -&gt; LoggingCache -&gt; SerializedCache -&gt; LruCache -&gt; PerpetualCacheã€‚</p>
</blockquote>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2018a/1f5233b2.jpg" srcset="/img/loading.gif" alt="img"></p>
<p>ä»¥ä¸‹æ˜¯å…·ä½“è¿™äº›Cacheå®ç°ç±»çš„ä»‹ç»ï¼Œä»–ä»¬çš„ç»„åˆä¸ºCacheèµ‹äºˆäº†ä¸åŒçš„èƒ½åŠ›ã€‚</p>
<ul>
<li><code>SynchronizedCache</code>ï¼šåŒæ­¥Cacheï¼Œå®ç°æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä½¿ç”¨synchronizedä¿®é¥°æ–¹æ³•ã€‚</li>
<li><code>LoggingCache</code>ï¼šæ—¥å¿—åŠŸèƒ½ï¼Œè£…é¥°ç±»ï¼Œç”¨äºè®°å½•ç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œå¦‚æœå¼€å¯äº†DEBUGæ¨¡å¼ï¼Œåˆ™ä¼šè¾“å‡ºå‘½ä¸­ç‡æ—¥å¿—ã€‚</li>
<li><code>SerializedCache</code>ï¼šåºåˆ—åŒ–åŠŸèƒ½ï¼Œå°†å€¼åºåˆ—åŒ–åå­˜åˆ°ç¼“å­˜ä¸­ã€‚è¯¥åŠŸèƒ½ç”¨äºç¼“å­˜è¿”å›ä¸€ä»½å®ä¾‹çš„Copyï¼Œç”¨äºä¿å­˜çº¿ç¨‹å®‰å…¨ã€‚</li>
<li><code>LruCache</code>ï¼šé‡‡ç”¨äº†Lruç®—æ³•çš„Cacheå®ç°ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„Key/Valueã€‚</li>
<li><code>PerpetualCache</code>ï¼š ä½œä¸ºä¸ºæœ€åŸºç¡€çš„ç¼“å­˜ç±»ï¼Œåº•å±‚å®ç°æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä½¿ç”¨äº†HashMapã€‚</li>
</ul>
<p>ç„¶åæ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ·æ–°ç¼“å­˜ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">flushCacheIfRequired(ms);<br></code></pre></td></tr></table></figure>

<p>åœ¨é»˜è®¤çš„è®¾ç½®ä¸­<code>SELECT</code>è¯­å¥ä¸ä¼šåˆ·æ–°ç¼“å­˜ï¼Œ<code>insert/update/delte</code>ä¼šåˆ·æ–°ç¼“å­˜ã€‚è¿›å…¥è¯¥æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flushCacheIfRequired</span><span class="hljs-params">(MappedStatement ms)</span> </span>&#123;<br>    Cache cache = ms.getCache();<br>    <span class="hljs-keyword">if</span> (cache != <span class="hljs-keyword">null</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;      <br>      tcm.clear(cache);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>MyBatisçš„<code>CachingExecutor</code>æŒæœ‰äº†<code>TransactionalCacheManager</code>ï¼Œå³ä¸Šè¿°ä»£ç ä¸­çš„tcmã€‚</p>
<p><code>TransactionalCacheManager</code>ä¸­æŒæœ‰äº†ä¸€ä¸ªMapï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Map&lt;Cache, TransactionalCache&gt; transactionalCaches = <span class="hljs-keyword">new</span> HashMap&lt;Cache, TransactionalCache&gt;();<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªMapä¿å­˜äº†Cacheå’Œç”¨<code>TransactionalCache</code>åŒ…è£…åçš„Cacheçš„æ˜ å°„å…³ç³»ã€‚</p>
<p><code>TransactionalCache</code>å®ç°äº†Cacheæ¥å£ï¼Œ<code>CachingExecutor</code>ä¼šé»˜è®¤ä½¿ç”¨ä»–åŒ…è£…åˆå§‹ç”Ÿæˆçš„Cacheï¼Œä½œç”¨æ˜¯å¦‚æœäº‹åŠ¡æäº¤ï¼Œå¯¹ç¼“å­˜çš„æ“ä½œæ‰ä¼šç”Ÿæ•ˆï¼Œå¦‚æœäº‹åŠ¡å›æ»šæˆ–è€…ä¸æäº¤äº‹åŠ¡ï¼Œåˆ™ä¸å¯¹ç¼“å­˜äº§ç”Ÿå½±å“ã€‚</p>
<p>åœ¨<code>TransactionalCache</code>çš„clearï¼Œæœ‰ä»¥ä¸‹ä¸¤å¥ã€‚æ¸…ç©ºäº†éœ€è¦åœ¨æäº¤æ—¶åŠ å…¥ç¼“å­˜çš„åˆ—è¡¨ï¼ŒåŒæ—¶è®¾å®šæäº¤æ—¶æ¸…ç©ºç¼“å­˜ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span> </span>&#123;<br>	clearOnCommit = <span class="hljs-keyword">true</span>;<br>	entriesToAddOnCommit.clear();<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>CachingExecutor</code>ç»§ç»­å¾€ä¸‹èµ°ï¼Œ<code>ensureNoOutParams</code>ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†å­˜å‚¨è¿‡ç¨‹çš„ï¼Œæš‚æ—¶ä¸ç”¨è€ƒè™‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="hljs-keyword">null</span>) &#123;<br>	ensureNoOutParams(ms, parameterObject, boundSql);<br></code></pre></td></tr></table></figure>

<p>ä¹‹åä¼šå°è¯•ä»tcmä¸­è·å–ç¼“å­˜çš„åˆ—è¡¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);<br></code></pre></td></tr></table></figure>

<p>åœ¨<code>getObject</code>æ–¹æ³•ä¸­ï¼Œä¼šæŠŠè·å–å€¼çš„èŒè´£ä¸€è·¯ä¼ é€’ï¼Œæœ€ç»ˆåˆ°<code>PerpetualCache</code>ã€‚å¦‚æœæ²¡æœ‰æŸ¥åˆ°ï¼Œä¼šæŠŠkeyåŠ å…¥Missé›†åˆï¼Œè¿™ä¸ªä¸»è¦æ˜¯ä¸ºäº†ç»Ÿè®¡å‘½ä¸­ç‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Object object = delegate.getObject(key);<br><span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span>) &#123;<br>	entriesMissedInCache.add(key);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>CachingExecutor</code>ç»§ç»­å¾€ä¸‹èµ°ï¼Œå¦‚æœæŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™è°ƒç”¨<code>tcm.putObject</code>æ–¹æ³•ï¼Œå¾€ç¼“å­˜ä¸­æ”¾å…¥å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (list == <span class="hljs-keyword">null</span>) &#123;<br>	list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>	tcm.putObject(cache, key, list); <span class="hljs-comment">// issue #578 and #116</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>tcmçš„<code>put</code>æ–¹æ³•ä¹Ÿä¸æ˜¯ç›´æ¥æ“ä½œç¼“å­˜ï¼Œåªæ˜¯åœ¨æŠŠè¿™æ¬¡çš„æ•°æ®å’Œkeyæ”¾å…¥å¾…æäº¤çš„Mapä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">putObject</span><span class="hljs-params">(Object key, Object object)</span> </span>&#123;<br>    entriesToAddOnCommit.put(key, object);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä»ä»¥ä¸Šçš„ä»£ç åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç™½ï¼Œå¦‚æœä¸è°ƒç”¨<code>commit</code>æ–¹æ³•çš„è¯ï¼Œç”±äº<code>TranscationalCache</code>çš„ä½œç”¨ï¼Œå¹¶ä¸ä¼šå¯¹äºŒçº§ç¼“å­˜é€ æˆç›´æ¥çš„å½±å“ã€‚å› æ­¤æˆ‘ä»¬çœ‹çœ‹<code>Sqlsession</code>çš„<code>commit</code>æ–¹æ³•ä¸­åšäº†ä»€ä¹ˆã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> force)</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      executor.commit(isCommitOrRollbackRequired(force));<br></code></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†CachingExecutorï¼Œé¦–å…ˆä¼šè¿›å…¥CachingExecutorå®ç°çš„commitæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    delegate.commit(required);<br>    tcm.commit();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¼šæŠŠå…·ä½“commitçš„èŒè´£å§”æ‰˜ç»™åŒ…è£…çš„<code>Executor</code>ã€‚ä¸»è¦æ˜¯çœ‹ä¸‹<code>tcm.commit()</code>ï¼Œtcmæœ€ç»ˆåˆä¼šè°ƒç”¨åˆ°<code>TrancationalCache</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commit</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (clearOnCommit) &#123;<br>      delegate.clear();<br>    &#125;<br>    flushPendingEntries();<br>    reset();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çœ‹åˆ°è¿™é‡Œçš„<code>clearOnCommit</code>å°±æƒ³èµ·åˆšæ‰<code>TrancationalCache</code>çš„<code>clear</code>æ–¹æ³•è®¾ç½®çš„æ ‡å¿—ä½ï¼ŒçœŸæ­£çš„æ¸…ç†Cacheæ˜¯æ”¾åˆ°è¿™é‡Œæ¥è¿›è¡Œçš„ã€‚å…·ä½“æ¸…ç†çš„èŒè´£å§”æ‰˜ç»™äº†åŒ…è£…çš„Cacheç±»ã€‚ä¹‹åè¿›å…¥<code>flushPendingEntries</code>æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flushPendingEntries</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : entriesToAddOnCommit.entrySet()) &#123;<br>      delegate.putObject(entry.getKey(), entry.getValue());<br>    &#125;<br>    ................<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨<code>flushPending</code>Entriesä¸­ï¼Œå°†å¾…æäº¤çš„Mapè¿›è¡Œå¾ªç¯å¤„ç†ï¼Œå§”æ‰˜ç»™åŒ…è£…çš„Cacheç±»ï¼Œè¿›è¡Œ<code>putObject</code>çš„æ“ä½œã€‚</p>
<p>åç»­çš„æŸ¥è¯¢æ“ä½œä¼šé‡å¤æ‰§è¡Œè¿™å¥—æµç¨‹ã€‚å¦‚æœæ˜¯<code>insert|update|delete</code>çš„è¯ï¼Œä¼šç»Ÿä¸€è¿›å…¥<code>CachingExecutor</code>çš„<code>update</code>æ–¹æ³•ï¼Œå…¶ä¸­è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flushCacheIfRequired</span><span class="hljs-params">(MappedStatement ms)</span></span><br></code></pre></td></tr></table></figure>

<p>åœ¨äºŒçº§ç¼“å­˜æ‰§è¡Œæµç¨‹åå°±ä¼šè¿›å…¥ä¸€çº§ç¼“å­˜çš„æ‰§è¡Œæµç¨‹ï¼Œå› æ­¤ä¸å†èµ˜è¿°ã€‚</p>
<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li>MyBatisçš„äºŒçº§ç¼“å­˜ç›¸å¯¹äºä¸€çº§ç¼“å­˜æ¥è¯´ï¼Œå®ç°äº†<code>SqlSession</code>ä¹‹é—´ç¼“å­˜æ•°æ®çš„å…±äº«ï¼ŒåŒæ—¶ç²’åº¦æ›´åŠ çš„ç»†ï¼Œèƒ½å¤Ÿåˆ°<code>namespace</code>çº§åˆ«ï¼Œé€šè¿‡Cacheæ¥å£å®ç°ç±»ä¸åŒçš„ç»„åˆï¼Œå¯¹Cacheçš„å¯æ§æ€§ä¹Ÿæ›´å¼ºã€‚</li>
<li>MyBatisåœ¨å¤šè¡¨æŸ¥è¯¢æ—¶ï¼Œæå¤§å¯èƒ½ä¼šå‡ºç°è„æ•°æ®ï¼Œæœ‰è®¾è®¡ä¸Šçš„ç¼ºé™·ï¼Œå®‰å…¨ä½¿ç”¨äºŒçº§ç¼“å­˜çš„æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ã€‚</li>
<li>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œç”±äºé»˜è®¤çš„MyBatis Cacheå®ç°éƒ½æ˜¯åŸºäºæœ¬åœ°çš„ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¿…ç„¶ä¼šå‡ºç°è¯»å–åˆ°è„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨é›†ä¸­å¼ç¼“å­˜å°†MyBatisçš„Cacheæ¥å£å®ç°ï¼Œæœ‰ä¸€å®šçš„å¼€å‘æˆæœ¬ï¼Œç›´æ¥ä½¿ç”¨Redisã€Memcachedç­‰åˆ†å¸ƒå¼ç¼“å­˜å¯èƒ½æˆæœ¬æ›´ä½ï¼Œå®‰å…¨æ€§ä¹Ÿæ›´é«˜ã€‚</li>
</ol>
<h2 id="å…¨æ–‡æ€»ç»“"><a href="#å…¨æ–‡æ€»ç»“" class="headerlink" title="å…¨æ–‡æ€»ç»“"></a>å…¨æ–‡æ€»ç»“</h2><p>æœ¬æ–‡å¯¹ä»‹ç»äº†MyBatisä¸€äºŒçº§ç¼“å­˜çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶ä»åº”ç”¨åŠæºç çš„è§’åº¦å¯¹MyBatisçš„ç¼“å­˜æœºåˆ¶è¿›è¡Œäº†åˆ†æã€‚æœ€åå¯¹MyBatisç¼“å­˜æœºåˆ¶åšäº†ä¸€å®šçš„æ€»ç»“ï¼Œä¸ªäººå»ºè®®MyBatisç¼“å­˜ç‰¹æ€§åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œå…³é—­ï¼Œå•çº¯ä½œä¸ºä¸€ä¸ªORMæ¡†æ¶ä½¿ç”¨å¯èƒ½æ›´ä¸ºåˆé€‚ã€‚</p>
<blockquote>
<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://tech.meituan.com/2018/01/19/mybatis-cache.html" target="_blank" rel="noopener">https://tech.meituan.com/2018/01/19/mybatis-cache.html</a></p>
</blockquote>
<p><strong>æ¬¢è¿å…³æ³¨å¾®ä¿¡å…¬ä¼—å· ï¼š</strong></p>
<img src="https://github.com/alterem/picFB/raw/master/pics/2020/04/07/006y8mN6gy1g7d3llw1nkj30b40b4wee.jpg" srcset="/img/loading.gif" alt="æ¬¢è¿å…³æ³¨å…¬ä¼—å·" style="width: 100px" />
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/MyBatis/">MyBatis</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/MyBatis/">MyBatis</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/10/16/%E8%A7%A3%E5%86%B3Catalina%E6%89%93%E5%BC%80%E5%BA%94%E7%94%A8%E5%BE%88%E6%85%A2%E7%9A%84%E9%97%AE%E9%A2%98/">
                        <span class="hidden-mobile">è§£å†³Catalinaæ‰“å¼€åº”ç”¨å¾ˆæ…¢çš„é—®é¢˜</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>



</body>
</html>
